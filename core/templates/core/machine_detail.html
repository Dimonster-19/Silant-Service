{% extends 'core/base.html' %}

{% block title %}–ú–∞—à–∏–Ω–∞ {{ machine.serial_number }} ‚Äî –°–∏–ª–∞–Ω—Ç{% endblock %}

{% block content %}

<div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1 style="margin: 0;">–ú–∞—à–∏–Ω–∞ {{ machine.serial_number }}</h1>
        
        {% if can_edit %}
          <a href="{% url 'core:machine_edit' serial_number=machine.serial_number %}" class="btn" style="padding: 0.8rem 1.8rem; font-size: 1.1rem;">
              ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
          </a>
        {% endif %}
    </div>

    <table class="data-table" style="width:100%; border-collapse: collapse;">
        <tbody>
            {% for label, value in fields %}
                <tr style="border-bottom: 1px solid #eee;">
                    <th style="width: 45%; padding: 1rem; background: var(--dark-blue); color: white; text-align: left;">
                        {{ label }}
                    </th>
                    <td style="padding: 1rem;">{{ value }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid #ddd;">
        <h2>–ò—Å—Ç–æ—Ä–∏—è –¢–û –∏ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π</h2>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <div style="margin: 1.5rem 0; display: flex; gap: 1rem; flex-wrap: wrap;">
            {% if can_add_maintenance %}
                <a href="{% url 'core:maintenance_create' serial_number=machine.serial_number %}"
                   class="btn" style="background: var(--dark-blue);">
                    + –î–æ–±–∞–≤–∏—Ç—å –¢–û
                </a>
            {% endif %}
            {% if can_add_claim %}
                <a href="{% url 'core:claim_create' serial_number=machine.serial_number %}"
                   class="btn" style="background: var(--dark-blue);">
                    + –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫–ª–∞–º–∞—Ü–∏—é
                </a>
            {% endif %}
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –¢–û -->
        <h3 style="margin-top: 2rem;">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)</h3>
        {% if maintenances %}
            <div class="data-table-container">
                <table class="data-table" style="width:100%; margin-top: 1rem;">
                    <thead>
                        <tr>
                            <th>–í–∏–¥ –¢–û</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ù–∞—Ä–∞–±–æ—Ç–∫–∞, –º/—á</th>
                            <th>–°–µ—Ä–≤–∏—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in maintenances %}
                        <tr>
                            <td>{{ m.type }}</td>
                            <td>{{ m.date|date:"d.m.Y" }}</td>
                            <td>{{ m.hours|default:"‚Äî" }}</td>
                            <td>
                                {% if m.organization %}
                                    {{ m.organization.email|default:m.organization }}
                                {% elif m.service_company %}
                                    {{ m.service_company.email|default:"‚Äî" }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                            <td style="white-space: nowrap; text-align: center;">
                                {% if can_edit or request.user == m.organization or request.user == m.service_company %}
                                    <a href="{% url 'core:maintenance_edit' pk=m.pk %}"
                                       title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¢–û"
                                       style="margin-right: 12px; font-size: 1.2rem; text-decoration: none;">‚úèÔ∏è</a>

                                    <a href="{% url 'core:maintenance_delete' pk=m.pk %}"
                                       title="–£–¥–∞–ª–∏—Ç—å –¢–û"
                                       onclick="event.stopPropagation(); return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –¢–û?');"
                                       style="color: var(--red); font-size: 1.2rem; text-decoration: none;">üóë</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" style="text-align:center; padding:1.5rem; color:#777;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¢–û</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
                <p style="margin-top: 1rem; color: #666;">
                    <a href="{% url 'core:dashboard' %}#maintenance">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¢–û ‚Üí</a>
                </p>
            {% else %}
                <p style="color: #777; margin-top: 1rem;">–ü–æ —ç—Ç–æ–π –º–∞—à–∏–Ω–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –¢–û</p>
            {% endif %}

        <!-- –¢–∞–±–ª–∏—Ü–∞ –†–µ–∫–ª–∞–º–∞—Ü–∏–π -->
        <h3 style="margin-top: 2rem;">–†–µ–∫–ª–∞–º–∞—Ü–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)</h3>
        {% if claims %}
            <div class="data-table-container">
                < class="data-table" style="width:100%; margin-top: 1rem;">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞ –æ—Ç–∫–∞–∑–∞</th>
                            <th>–£–∑–µ–ª</th>
                            <th>–î–∞—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</th>
                            <th>–ü—Ä–æ—Å—Ç–æ–π (–¥–Ω–µ–π)</th>
                            <th>–°–µ—Ä–≤–∏—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in claims %}
                        <tr>
                            <td>{{ c.failure_date|date:"d.m.Y" }}</td>
                            <td>{{ c.failure_node }}</td>
                            <td>{{ c.recovery_date|date:"d.m.Y"|default:"‚Äî" }}</td>
                            <td>{{ c.downtime|default:"‚Äî" }}</td>
                            <td>{{ c.service_company.email|default:"‚Äî" }}
                            <td style="white-space: nowrap; text-align: center;">
                                {% if can_edit or request.user == c.service_company %}
                                    <a href="{% url 'core:claim_edit' pk=c.pk %}" style="margin-right: 8px;">‚úèÔ∏è</a>
                                    <a href="{% url 'core:claim_delete' pk=c.pk %}" style="color: var(--red);">üóë</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p style="margin-top: 1rem; color: #666;">
                <a href="{% url 'core:dashboard' %}#claims">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–∏ ‚Üí</a>
            </p>
        {% else %}
            <p style="color: #777; margin-top: 1rem;">–ü–æ —ç—Ç–æ–π –º–∞—à–∏–Ω–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π</p>
        {% endif %}
    </div>

</div>

{% endblock %}