{% extends 'core/base.html' %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî –°–∏–ª–∞–Ω—Ç{% endblock %}

{% block content %}

<h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
<p>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong>{{ user.email }}</strong></p>

<div class="tabs-container" style="margin-top: 2rem;">

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º -->
    <div class="tabs-header" style="display: flex; border-bottom: 2px solid #ccc;">
        <button class="tab-btn active" data-tab="machines">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</button>
        <button class="tab-btn" data-tab="maintenance">–¢–û</button>
        <button class="tab-btn" data-tab="claims">–†–µ–∫–ª–∞–º–∞—Ü–∏–∏</button>
    </div>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="tab-content">

        <!-- –í–∫–ª–∞–¥–∫–∞ –ú–∞—à–∏–Ω—ã -->
        <div id="machines" class="tab-panel active">
            <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—à–∏–Ω—ã</h2>
            {% if can_edit %}
              <p style="margin: 1.5rem 0;">
                  <a href="{% url 'core:machine_create' %}" class="btn" style="font-size: 1.1rem;">
                      + –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–∞—à–∏–Ω—É
                  </a>
              </p>
            {% endif %}

            {% if machines %}
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–ó–∞–≤. ‚Ññ</th>
                                <th>–ú–æ–¥–µ–ª—å</th>
                                <th>–î–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–°–µ—Ä–≤–∏—Å–Ω–∞—è –æ—Ä–≥.</th>
                                {% if can_edit %}
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                {% endif %}
                            </tr>
                        </thead>
                    <tbody>
                        {% for m in machines %}
                        <tr style="cursor: pointer;" onclick="window.location.href='{% url 'core:machine_detail' serial_number=m.serial_number %}'">
                            <td>{{ m.serial_number }}</td>
                            <td>{{ m.model.name|default:"‚Äî" }}</td>
                            <td>{{ m.shipment_date|date:"d.m.Y"|default:"‚Äî" }}</td>
                            <td>{{ m.client.email|default:"‚Äî" }}</td>
                            <td>{{ m.service_company.email|default:"‚Äî" }}</td>
                            {% if can_edit %}
                                <td>
                                    <a href="{% url 'core:machine_edit' serial_number=m.serial_number %}" style="text-decoration: none;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                                </td>
                            {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{% if can_edit %}6{% else %}5{% endif %}" style="text-align:center; padding:2rem; color:#777;">
                                –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—à–∏–Ω
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            {% else %}
                <p style="margin-top:1.5rem; font-size:1.1rem; color:#555;">
                    –ü–æ–∫–∞ –Ω–µ—Ç –º–∞—à–∏–Ω, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.
                </p>
            {% endif %}
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –¢–û -->
        <div id="maintenance" class="tab-panel">
            <h2>–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</h2>

            {% if maintenances %}
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–ú–∞—à–∏–Ω–∞</th>
                                <th>–í–∏–¥ –¢–û</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ù–∞—Ä–∞–±–æ—Ç–∫–∞, –º/—á</th>
                                <th>–°–µ—Ä–≤–∏—Å / –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                    <tbody>
                        {% for m in maintenances %}
                            <tr style="cursor:pointer;">
                                <td onclick="window.location.href='{% url 'core:machine_detail' serial_number=m.machine.serial_number %}'">{{ m.machine.serial_number }}</td>
                                <td onclick="window.location.href='{% url 'core:machine_detail' serial_number=m.machine.serial_number %}'">{{ m.type }}</td>
                                <td onclick="window.location.href='{% url 'core:machine_detail' serial_number=m.machine.serial_number %}'">{{ m.date|date:"d.m.Y" }}</td>
                                <td onclick="window.location.href='{% url 'core:machine_detail' serial_number=m.machine.serial_number %}'">{{ m.hours|default:"‚Äî" }}</td>
                                <td onclick="window.location.href='{% url 'core:machine_detail' serial_number=m.machine.serial_number %}'">
                                    {% if m.organization %}
                                        {{ m.organization }}
                                    {% elif m.service_company %}
                                        {{ m.service_company }}
                                    {% else %}
                                        ‚Äî
                                    {% endif %}
                                </td>
                                <td style="white-space: nowrap; text-align: center;">
                                    {% if is_manager or request.user == m.organization or request.user == m.service_company %}
                                        <a href="{% url 'core:maintenance_edit' pk=m.pk %}"
                                           title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¢–û"
                                           style="margin-right: 12px; font-size: 1.2rem; text-decoration: none;">‚úèÔ∏è</a>

                                        <a href="{% url 'core:maintenance_delete' pk=m.pk %}"
                                           title="–£–¥–∞–ª–∏—Ç—å –¢–û"
                                           onclick="event.stopPropagation(); return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –¢–û?');"
                                           style="color: var(--red); font-size: 1.2rem; text-decoration: none;">üóë</a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="6" style="text-align:center; padding: 3rem 1rem; color:#777; font-style: italic;">
                                    –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p style="color:#777; margin-top:1.5rem;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –¢–û</p>
            {% endif %}
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –†–µ–∫–ª–∞–º–∞—Ü–∏–∏ -->
        <div id="claims" class="tab-panel">
            <h2>–†–µ–∫–ª–∞–º–∞—Ü–∏–∏</h2>

            {% if claims %}
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–ú–∞—à–∏–Ω–∞</th>
                                <th>–î–∞—Ç–∞ –æ—Ç–∫–∞–∑–∞</th>
                                <th>–£–∑–µ–ª –æ—Ç–∫–∞–∑–∞</th>
                                <th>–î–∞—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</th>
                                <th>–ü—Ä–æ—Å—Ç–æ–π (–¥–Ω–µ–π)</th>
                                <th>–°–µ—Ä–≤–∏—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                    <tbody>
                        {% for c in claims %}
                            <tr style="cursor:pointer;">
                                <td onclick="window.location.href='{% url 'core:machine_detail' serial_number=c.machine.serial_number %}'">{{ c.machine.serial_number }}</td>
                                <td onclick="window.location.href='{% url 'core:machine_detail' serial_number=c.machine.serial_number %}'">{{ c.failure_date|date:"d.m.Y" }}</td>
                                <td onclick="window.location.href='{% url 'core:machine_detail' serial_number=c.machine.serial_number %}'">{{ c.failure_node }}</td>
                                <td onclick="window.location.href='{% url 'core:machine_detail' serial_number=c.machine.serial_number %}'">{{ c.recovery_date|date:"d.m.Y"|default:"‚Äî" }}</td>
                                <td onclick="window.location.href='{% url 'core:machine_detail' serial_number=c.machine.serial_number %}'">{{ c.downtime|default:"‚Äî" }}</td>
                                <td onclick="window.location.href='{% url 'core:machine_detail' serial_number=c.machine.serial_number %}'">{{ c.service_company|default:"‚Äî" }}</td>
                                <td style="white-space: nowrap; text-align: center;">
                                    {% if is_manager or request.user == m.organization or request.user == m.service_company %}
                                        <a href="{% url 'core:claim_edit' pk=c.pk %}"
                                           title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–ª–∞–º–∞—Ü–∏—é"
                                           style="margin-right: 12px; font-size: 1.2rem; text-decoration: none;">‚úèÔ∏è</a>

                                        <a href="{% url 'core:claim_delete' pk=c.pk %}"
                                           title="–£–¥–∞–ª–∏—Ç—å —Ä–µ–∫–ª–∞–º–∞—Ü–∏—é"
                                           onclick="event.stopPropagation(); return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ä–µ–∫–ª–∞–º–∞—Ü–∏—é?');"
                                           style="color: var(--red); font-size: 1.2rem; text-decoration: none;">üóë</a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="7" style="text-align:center; padding: 3rem 1rem; color:#777; font-style: italic;">
                                    –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p style="color:#777; margin-top:1.5rem;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π</p>
            {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .tabs-header { margin-bottom: 1.5rem; }
    .tab-btn {
        padding: 0.9rem 1.8rem;
        font-size: 1.1rem;
        background: #f0f0f0;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
    }
    .tab-btn:hover { background: #e0e0e0; }
    .tab-btn.active {
        background: white;
        border-bottom: 3px solid var(--red);
        font-weight: bold;
        color: var(--dark-blue);
    }
    .tab-panel {
        display: none;
        padding: 1.5rem;
        background: white;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .tab-panel.active { display: block; }
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    .data-table th, .data-table td {
        padding: 0.9rem 1.2rem;
        border-bottom: 1px solid #eee;
        text-align: left;
    }
    .data-table th { background: var(--dark-blue); color: white; }
    .data-table tr:hover { background: #f8f9fa; }
    .data-table td:last-child { text-align: center; width: 110px; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('.tab-btn');
        const panels = document.querySelectorAll('.tab-panel');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                panels.forEach(p => p.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
    });
</script>

{% endblock %}